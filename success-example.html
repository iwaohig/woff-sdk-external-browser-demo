<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>WOFF SDK 成功例</title>
  <script charset="utf-8" src="https://static.worksmobile.net/static/wm/woff/edge/3.6.2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #output { white-space: pre-wrap; background: #f5f5f5; padding: 1em; border: 1px solid #ccc; }
    h2 { margin-top: 2em; }
  </style>
</head>
<body>
  <h1>WOFF SDK 成功例</h1>
  <div id="output">ログ出力:</div>

  <script>
    const woffId = 'ioka5CiR7TDYN-FK_XKYcQ';
    const redirectUri = "https://iwaohig.github.io/woff-sdk-external-browser-demo/success-example.html";
    const outputDiv = document.getElementById("output");

    // console 出力を画面にも表示
    const originalLog = console.log;
    const originalErr = console.error;
    console.log = function (...args) {
      outputDiv.innerText += '\n' + args.join(' ');
      originalLog.apply(console, args);
    };
    console.error = function (...args) {
      outputDiv.innerText += '\n[ERROR] ' + args.join(' ');
      originalErr.apply(console, args);
    };

    window.addEventListener('load', () => {
      woff.init({ woffId })
        .then(() => {
          console.log("woff initialized");

          if (!woff.isLoggedIn()) {
            console.log("not logged in yet, calling login...");
            outputDiv.innerText += "\n※ログイン前の状態です。ログやネットワーク状況を確認できます。";
            const goLogin = confirm("まだログインしていません。\nLINE WORKS ログイン画面へ進みますか？");

            if (!goLogin) {
              console.log("ログインをキャンセルしました。");
              return;
            }

            console.log("5秒待ってから login を開始します...");
            setTimeout(() => {
              woff.login({ redirectUri }).then(() => {
                console.log("再度 init 実行中...");
                return woff.init({ woffId });
              }).then(() => {
                return woff.getProfile();
              }).then(profile => {
                console.log("プロフィール取得成功", JSON.stringify(profile, null, 2));
                showProfile(profile);
              }).catch(err => {
                console.error("エラー:", err);
              });
            }, 5000); // ← ここで5秒待つ

            return;
          }

          return woff.getProfile().then(profile => {
            console.log("プロフィール取得成功", JSON.stringify(profile, null, 2));
            showProfile(profile);
          });
        })
        .catch(err => {
          console.error("エラー:", err);
        });

      function showProfile(profile) {
        const html = `
          <h2>ログインユーザー情報</h2>
          <ul>
            <li><strong>表示名:</strong> ${profile.displayName || 'N/A'}</li>
            <li><strong>メール:</strong> ${profile.email || 'N/A'}</li>
            <li><strong>ユーザーID:</strong> ${profile.userId || 'N/A'}</li>
            <li><strong>ドメインID:</strong> ${profile.domainId || 'N/A'}</li>
          </ul>
        `;
        outputDiv.innerHTML += html;
      }
    });
  </script>
</body>
</html>
